<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html>
<head>
  <script src='http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js'></script>
  <script src='js/json2.js'></script>
  <script type="text/javascript" src="http://cdn.simplegeo.com/js/1.3/simplegeo.places.min.js">
  </script>
  <script src="http://polymaps.org/modernizr.min.js?1.5"></script>
  <script src="http://polymaps.org/polymaps.min.js?2.5.0"></script>
  <script src="http://polymaps.org/nns.min.js?1.1.0"></script>
  <style type="text/css">
  @import url("css/screen.css");
  @import url("css/style.css");
   
  div#map {
    background: #021019;
    }
     
    .compass .back {
      fill: #256574;
    }
       
    .compass .fore, .compass .chevron {
      stroke: #1AA398;
    }
	 
  </style> 

  <script>
  $(document).ready(function(){
    if(!("WebSocket" in window)) {
      alert("Sorry, the build of your browser does not support WebSockets. Please use latest Chrome or Webkit nightly");
      return;
    }

    
    ws = new WebSocket("ws://localhost:8080/");
    window.datadebug = [];
    window.buffer = "";
    window.geodebug = [];
    window.geocount = {'geo':0, 'nogeo':0};

    var gettweet = function(tw) {
      var p = $("<div class='tweet' style='display:none'><div class='content'><a class='main-screenname' href='http://www.twitter.com/" + tw.user.screen_name + "/status/" + tw.id + "' target='_blank'>" + tw.user.screen_name + "</a> " + tw.text + "</div></div>");
      u = tw.user;
      if (tw.user.geo_enabled) {
      //if (tw.geo) {		      
		      window.geocount.geo += 1
		      console.debug('one more geo...')
		      geodebug.push(tw);
		      } else {
		      window.geocount.nogeo += 1
	      }
      checkscroll(p);
      window.datadebug.push(tw);
      //checkscroll();
    };

    var checkscroll = function(p) {
      if($('#tweets div.tweet').size() > 15) {
        $('#tweets div.tweet:last').slideDown(100, function() {
          $(this).remove();
        });
      }
      $('#tweets').prepend(p);
      p.slideDown(140);
    }

    ws.onmessage = function(evt) { 
      lc = evt.data.substr(evt.data.length - 3)
      if (lc === "}\r\n") {
        //console.debug('new tweet!');
	try {
	  chunk = window.buffer + evt.data;
	  tw = JSON.parse(chunk);
	} catch(e) {
	  //console.debug('PROBLEM PARSING !!!' + chunk);
	  //console.debug('some problem parsing... :(');
	  //XXX fixme this shit
	}
	gettweet(tw);
	window.buffer = "";
      } else {
	window.buffer = window.buffer + evt.data;
      }
    };
    ws.onclose = function() {
      alert("socket closed");
    };
    ws.onopen = function() {
	console.debug('socket opened...');
    };
  });
  </script>
</head>
<body>
  <div id="tweets" style="width:45%;float:right;">
  </div>
  <div id="map" style="width:50%;float:left;">
	  <!--<h1>Toma la plaza!</h1>-->
  </div>


<script type="text/javascript">

function load(e) {
  var cluster = e.tile.cluster || (e.tile.cluster = kmeans()
      .iterations(2)
      .size(200));

  for (var i = 0; i < e.features.length; i++) {
    cluster.add(e.features[i].data.geometry.coordinates);
  }

  var tile = e.tile, g = tile.element;
  while (g.lastChild) g.removeChild(g.lastChild);

  var means = cluster.means();
  means.sort(function(a, b) { return b.size - a.size; });
  for (var i = 0; i < means.length; i++) {
    var mean = means[i], point = g.appendChild(po.svg("circle"));
    point.setAttribute("cx", mean.x);
    point.setAttribute("cy", mean.y);
    point.setAttribute("r", Math.pow(2, tile.zoom - 11) * Math.sqrt(mean.size));
  }
}


var po = org.polymaps;

var map = po.map()
    .container(document.getElementById("map").appendChild(po.svg("svg")))
    .center({lat: 43.45, lon: 6.15})
    .zoom(4)
    .add(po.interact())
    .add(po.hash());

map.add(po.image()
    .url(po.url("http://{S}tile.cloudmade.com"
    + "/20d51d736e5d4b5db64cd22d11e81194" //FIXME add your api key
    + "/999/256/{Z}/{X}/{Y}.png")
    .hosts(["a.", "b.", "c.", ""])));

//map.add(po.geoJson()
//    .url('/')
//    .on("load", load)
//    .clip(false)
//    .zoom(14));

map.add(po.compass()
    .pan("none"));


var testp = function() {
data = {"type": "FeatureCollection",
  	"features": [
        {"id":"177639",
	 "type":"Feature",
	 "geometry":{
		"type":"Point",
		"coordinates":[-3.51,40.31]
	}}]
}
map.add(po.geoJson()
	.features(data)
	.on("load", load)
	.clip(false)
	.zoom(14))
}

</script>
</body>
</html>
